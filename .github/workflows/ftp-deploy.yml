name: Deploy React + PHP (Backend Folder)

on:
  push:
    branches:
      - main  # O deploy acontece sempre que enviares algo para a branch main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout do C√≥digo
        uses: actions/checkout@v4

      - name: üü¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Instalar Depend√™ncias
        run: npm install

      - name: üî® Build do Projeto React
        run: npm run build
        # Nota: Se usares Vite, o comando gera a pasta 'dist'. 
        # Se usares Create React App, gera a pasta 'build'.

      - name: üìÇ Organizar ficheiros para o Servidor
        run: |
          # 1. Identificar a pasta de build (dist ou build)
          BUILD_DIR=$([ -d "dist" ] && echo "dist" || echo "build")
          echo "Pasta de build detectada: $BUILD_DIR"
          
          # 2. Copiar a pasta backend para dentro da pasta de build
          # O comando -r copia a pasta inteira com o login.php l√° dentro
          if [ -d "backend" ]; then
            cp -r backend $BUILD_DIR/
            echo "‚úÖ Pasta backend copiada com sucesso."
          else
            echo "‚ö†Ô∏è Pasta backend n√£o encontrada no reposit√≥rio!"
          fi
          
          # 3. Guardar o nome da pasta para o pr√≥ximo passo
          echo "FINAL_DIR=$BUILD_DIR" >> $GITHUB_ENV

      - name: ‚è´ FTP Deploy
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # Usa a pasta de build que detet√°mos acima
          local-dir: ./${{ env.FINAL_DIR }}/
          # Envia para a raiz do servidor (ex: public_html/)
          server-dir: ./
          # Mantemos false para n√£o apagar pastas importantes do servidor
          dangerous-clean-up: false