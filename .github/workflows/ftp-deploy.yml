name: Deploy Slim + React (API e Frontend)

on:
  push:
    branches:
      - main 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout do CÃ³digo
        uses: actions/checkout@v4

      # --- 1. BUILD DO FRONTEND (REACT) ---
      
      - name: ğŸŸ¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 

      - name: ğŸ“¦ Instalar DependÃªncias do React
        run: npm install
        # ğŸ¯ CORRIGIDO: Agora aponta para a pasta 'frontend'
        working-directory: ./frontend 

      - name: ğŸ”¨ Build do Projeto React
        run: npm run build
        # O output (frontend estÃ¡tico) serÃ¡ gerado em: ./frontend/build/ (ou dist/)
        # Assumindo que o build gera a pasta 'build'
        working-directory: ./frontend 
        
      # --- 2. PREPARAÃ‡ÃƒO DO BACKEND (SLIM) ---
      
      - name: ğŸ˜ Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, zip, pdo_mysql 
          coverage: none
          
      - name: ğŸ“¦ Instalar DependÃªncias PHP (Composer)
        run: composer install --prefer-dist --no-dev --optimize-autoloader
        # ğŸ¯ CORRIGIDO: Agora aponta para a pasta 'backend'
        working-directory: ./backend 

      # --- 3. DEPLOY FTP (ESTRUTURA HÃBRIDA) ---
      
      # A) Deploy do Frontend (React) para a RAIZ do SubdomÃ­nio
      - name: â« A) Deploy do Frontend (React)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # ğŸ¯ CORRIGIDO: Envia o conteÃºdo da pasta de BUILD do React
          # Deve ser: ./frontend/build/ ou ./frontend/dist/
          local-dir: './frontend/build/' 
          remote-dir: '/' # O utilizador acede a seudominio.pt/

      # B) Deploy do Backend (Slim) para um SubdiretÃ³rio 'api'
      - name: â« B) Deploy do Backend (Slim)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # ğŸ¯ CORRIGIDO: Envia a pasta pÃºblica do Slim (que tem o index.php)
          local-dir: './backend/public/' 
          remote-dir: '/api/' # A API estarÃ¡ acessÃ­vel em seudominio.pt/api/
          
      # C) Opcional: Deploy da pasta vendor (para um local seguro)
      - name: â« C) Deploy da Pasta 'vendor' (para um local seguro)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          # ğŸ¯ CORRIGIDO: Envia a pasta vendor criada em ./backend/vendor/
          local-dir: './backend/vendor/' 
          remote-dir: '/slim_root/vendor/'